# Outbound call recording

This Flex plugin provides call recording for outbound calls.  
Calls are recorded on dual channels, and the recorded data can be viewed from within Flex Insights.  

## Configuration

The plugin consists of two parts: the Flex Plugin and the Serverless Function.  
The Serverless Function is called from within the Flex Plugin.

## Setup Function

```sh
% cd serverless-functions
% cp .env.sample .env
```

Update the copied .env file with an editor. The contents to be updated are as follows.

Params|Values
:--|:--
ACCOUNT_SID|AccountSid of Twilio Flex Project
AUTH_TOKEN|No need to set
API_KEY|Twilio API Key (String starting with 'SK')
API_SECRET|API Secret paired with API Key

If you do not have an API Key and API Secret, create one from the Twilio administration console.

Once the .env file has been updated, deploy with the following command.

```sh
% npm run deploy
> serverless-outbound-recording@0.0.0 deploy
> twilio serverless:deploy


Deploying functions & assets to the Twilio Runtime

Username        SK***
Password        ***
Service SID     ZS***
Environment     dev
Root Directory  /***/plugin-outbound-recording/serverless-functions
Dependencies    twilio, @twilio/runtime-handler
Env Variables   API_KEY, API_SECRET
Runtime         node14

âœ” Serverless project successfully deployed

Deployment Details
Domain: serverless-outbound-recording-XXXX-dev.twil.io
Service:
   serverless-outbound-recording (ZS***)
Environment:
   dev (ZE***)
Build SID:
   ZB***
Runtime:
   node14
View Live Logs:
   https://www.twilio.com/console/functions/editor/ZS***/environment/ZE***
Functions:
   https://serverless-outbound-recording-XXXX-dev.twil.io/create-recording
Assets:
```

When the deployment is complete, record the "Domain:" shown in the results.
Such as "serverless-outbound-recording-XXXX-dev.twil.io".

## Setup Plugin

```sh
% cd ../
% cp .env.sample .env
```

Update the copied .env file with an editor.The contents to be updated are as follows.

Params|Values
:--|:--
FLEX_APP_ACCOUNT_SID|AccountSid of Twilio Flex Project
FLEX_APP_FUNCTIONS_DOMAIN|The "Domain" of the Function you just recorded

Don't forget to prefix each parameter with "FLEX_APP_".

Once the .env file has been updated, build and deploy with the following command.

### Build

```sh
% npm run build

Using profile XXXXXXXXX (AC***)

Compiling a production build...

Browserslist: caniuse-lite is outdated. Please run:
  npx browserslist@latest --update-db
  Why you should do it regularly: https://github.com/browserslist/browserslist#browsers-data-updating
Browserslist: caniuse-lite is outdated. Please run:
npx browserslist@latest --update-db

Why you should do it regularly:
https://github.com/browserslist/browserslist#browsers-data-updating
Plugin plugin-outbound-recording was successfully compiled.

3 files were compiled:
         65.1 KB         build/plugin-outbound-recording.js
         0.1 KB          build/plugin-outbound-recording.js.LICENSE.txt
         0.1 KB          build/plugin-outbound-recording.js.map

Your plugin is now ready to be deployed.
You can deploy it to Twilio using:

         npm run deploy
```

### Deploy

```sh:deploy

> plugin-outbound-recording@0.0.3 deploy
> twilio flex:plugins:deploy --changelog='Deploy at '+`date +%Y%m%d_%H%M%S`

Using profile XXXXXXXXX (AC***)

âœ” Validating deployment of plugin plugin-outbound-recording
â ¹ Compiling a production build of plugin-outbound-recordingBrowserslist: caniuse-lite is outdated. Please run:
  npx browserslist@latest --update-db
  Why you should do it regularly: https://github.com/browserslist/browserslist#browsers-data-updating
Browserslist: caniuse-lite is outdated. Please run:
npx browserslist@latest --update-db

Why you should do it regularly:
https://github.com/browserslist/browserslist#browsers-data-updating
âœ” Compiling a production build of plugin-outbound-recording
âœ” Uploading plugin-outbound-recording
âœ” Registering plugin plugin-outbound-recording with Plugins API
âœ” Registering version v0.0.4 with Plugins API

ðŸš€ Plugin (private) plugin-outbound-recording@0.0.4 was successfully deployed using Plugins API

Next Steps:
Run $ twilio flex:plugins:release --plugin plugin-outbound-recording@0.0.4 --name "Autogenerated Release 1655765907956" --description "The description of this Flex Plugin Configuration." to enable this plugin on your Flex application
```

Finally, execute the release command as described in "Next Steps:".

```sh
% twilio flex:plugins:release --plugin plugin-outbound-recording@0.0.4 --name "Autogenerated Release 1655765907956" --description "The description of this Flex Plugin Configuration."
Using profile XXXXXXXXX (AC***)

âœ” Creating configuration
âœ” Enabling configuration FJ***

ðŸš€ Configuration FJ*** was successfully enabled.

Next Steps:
Visit https://flex.twilio.com/admin/plugins to see your plugin(s) live on Flex.
```

## Code Description

`./src/OutboundRecordingPlugin.js`

```javascript
  async init(flex, manager) {
    flex.Actions.addListener('afterAcceptTask', async (payload) => {
      if (payload.task.attributes.direction === 'outbound') {
        let conference = null;
        // Waiting a conference object made.
        while (!conference) {
          await new Promise((resolve) => setTimeout(resolve, 500)); // Sleep 0.5 seconds
          conference = payload.task.conference || null;
        }
        // Make a hook that participant added to conference.
        conference.source.map.on('itemAdded', async (data) => {
          const callSid = data.item.descriptor.key || '';
          if (callSid) {
            // Start recording for outbound call.
            const { FLEX_APP_FUNCTIONS_DOMAIN, FLEX_APP_ACCOUNT_SID } =
              process.env;
            const url = `https://${FLEX_APP_FUNCTIONS_DOMAIN}/create-recording?callSid=${callSid}`;
            const res = await axios.post(url);
            // Add a attributes for Flex Insights CONVERSATIONS.
            const newAttributes = {
              ...payload.task.attributes,
              conversations: {
                media: [
                  {
                    url: `https://api.twilio.com/2010-04-01/Accounts/${FLEX_APP_ACCOUNT_SID}/Recordings/${res.data.sid}`,
                    type: 'VoiceRecording',
                    start_time: res.data.startTime,
                    channels: ['customer', 'others'],
                  },
                ],
              },
              type: 'outbound',
              call_sid: callSid,
              account_sid: FLEX_APP_ACCOUNT_SID,
              caller: payload.task.attributes.from,
              to: payload.task.attributes.outbound_to,
              name: payload.task.attributes.outbound_to,
            };
            // Update task.
            payload.task.setAttributes(newAttributes);
          }
        });
      }
    });
  }
```

Use the `afterAcceptTask` event in `Actions` to get the Conference for a task when it is accepted.  

At this point, there are still no participants in the Conference.So, the Conference's `itemAdded` event is hooked to describe the process to be followed when a participant is registered.

Then, when a participant is added, the CallSid of that participant is obtained and Functions is called with CallSid.

`./serverless-functions/functions/create-recording.js`

```javascript
/**
 * Start recording
 */
const Twilio = require('twilio');
exports.handler = async function (context, event, callback) {
  const response = new Twilio.Response();
  response.appendHeader('Access-Control-Allow-Origin', '*');
  response.appendHeader('Access-Control-Allow-Methods', 'OPTIONS, POST, GET');
  response.appendHeader('Access-Control-Allow-Headers', 'Content-Type');
  try {
    // Got a parameter
    const callSid = event.callSid || '';
    if (!callSid) throw new Error('Parameter error.');

    const twilioClient = Twilio(context.API_KEY, context.API_SECRET, {
      accountSid: context.ACCOUNT_SID,
    });
    const res = await twilioClient.calls(callSid).recordings.create({
      recordingChannels: 'dual',
    });
    response.appendHeader('Content-Type', 'application/json');
    response.setBody(res);
    callback(null, response);
  } catch (err) {
    console.error(err.message ? err.message : err);
    response.appendHeader('Content-Type', 'plain/text');
    response.setBody(err);
    callback(null, response);
  }
};
```

On the Functions side, It is only use the Recording API to start recording the CallSid obtained.

## Restrictions

If you wish to use this plugin with Salesforce integration, you will need to upgrade Click-to-Dial. Please refer to the following link for upgrade instructions.

<https://www.twilio.com/docs/flex/admin-guide/integrations/salesforce/upgrade-guide>
